{% set ip_hint=((edgeCluster.relocatable.ipv4_subnet | default(relocatable_ipv4_subnet)) | ansible.utils.nthhost(0)) + " " + ((edgeCluster.relocatable.ipv6_subnet | default(relocatable_ipv6_subnet)) | ansible.utils.nthhost(0)) %}
apiVersion: v1
kind: ConfigMap
metadata:
  name: "agent-config-map"
  namespace: "{{ metadata.name }}"
data:
  disable_samples.yaml: |
    apiVersion: samples.operator.openshift.io/v1
    kind: Config
    metadata:
      name: cluster
    spec:
      architectures:
        - x86_64
      managementState: Removed
{% if controlPlane.replicas == 1 %}
  disable_sno_network_diag.yaml: |
    apiVersion: operator.openshift.io/v1
    kind: Network
    metadata:
      name: cluster
    spec:
      disableNetworkDiagnostics: true
{% endif %}
{% if edgeCluster.relocatable is defined %}
{% for node_type in ["master", "worker"] %}
  set_node_ip_hint_{{ node_type }}.yaml: |
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    metadata:
      labels:
        machineconfiguration.openshift.io/role: {{ node_type }}
      name: 99-nodeip-hint-{{ node_type }}
    spec:
      config:
        ignition:
          version: 3.2.0
        storage:
          files:
            - contents:
                source: data:text/plain;charset=utf-8;base64,{{ ("KUBELET_NODEIP_HINT='" + ip_hint + "'") | b64encode }}
              mode: 0644
              overwrite: true
              path: /etc/default/nodeip-configuration
              user:
                name: root
  relocatable_ip_{{ node_type }}.yaml: |
    apiVersion: machineconfiguration.openshift.io/v1
    kind: MachineConfig
    metadata:
      labels:
        machineconfiguration.openshift.io/role: {{ node_type }}
      name: 99-{{ node_type }}-relocatable-ip
    spec:
      config:
        {{ lookup('ansible.builtin.template', 'RelocatableConfig.yaml.j2') | indent(8) }}
{% endfor %}
{% endif %}
