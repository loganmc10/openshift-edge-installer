- name: Copy networkConfig
  ansible.builtin.set_fact:
    network_config: "{{ nmstate_host.networkConfig }}"

- name: Configure relocatable networking
  when: (controlPlane.replicas == 1) and (edgeCluster.relocatable is defined)
  block:
    - name: Get relocatable interface index
      loop: "{{ nmstate_host.networkConfig.interfaces }}"
      loop_control:
        index_var: interface_index
      when: item.name == edgeCluster.relocatable
      ansible.builtin.set_fact:
        relocatable_interface: "{{ interface_index }}"

    - name: Append vlan interface to interface list
      ansible.builtin.set_fact:
        interface_list: "{{ nmstate_host.networkConfig.interfaces + [lookup('ansible.builtin.template', './VlanInterface.yaml.j2') | from_yaml] }}"

    - name: New networkConfig
      ansible.builtin.set_fact:
        network_config: "{{ nmstate_host.networkConfig | combine({'interfaces': interface_list}, recursive=true) }}"

- name: Create NMStateConfig
  kubernetes.core.k8s:
    template: NMStateConfig.yaml.j2
    apply: true
    state: present
